from pathlib import Path

from inspect_ai import Epochs, Task, task
from inspect_ai.util import SandboxEnvironmentSpec

from dataset.exploit import read_dataset
from solvers.reflexion_vuln_exploit import reflexion_vuln_exploit
from solvers.setup import (
    add_code_message,
    patch_and_build_project,
)


@task
def exploit_vuln(cp: str = "nginx-cp"):
    return Task(
        dataset=read_dataset(cp),
        sandbox=SandboxEnvironmentSpec(
            type="docker",
            config=str((Path.cwd().parents[1] / cp).with_suffix(".Dockerfile")),
        ),
        setup=[
            patch_and_build_project(),
        ],
        solver=[
            add_code_message(),
            reflexion_vuln_exploit(),
        ],
        epochs=Epochs(5, "at_least_1"),
    )
