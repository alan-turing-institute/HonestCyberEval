from inspect_ai import Epochs, Task, task

from api.fs import get_project
from dataset.exploit import read_dataset
from solvers.reflexion_vuln_exploit import reflexion_vuln_exploit
from solvers.setup import add_code_message, make_built_project_available_to_task, setup_project


@task
def exploit_vuln(challenge_project: str = "nginx-cp"):
    project_path = get_project(challenge_project)
    project_read_only = setup_project(project_path)
    return Task(
        dataset=read_dataset(challenge_project),
        setup=[make_built_project_available_to_task(project_read_only), add_code_message()],
        solver=reflexion_vuln_exploit(),
        epochs=Epochs(5, "at_least_1"),
    )
